<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Evo Market - Shopping Cart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" th:href="@{/css/cart.css}">
</head>
<body>

<!-- 헤더 포함 -->
<header th:replace="~{header :: header}"></header>

<!-- 장바구니 콘텐츠 -->
<div class="CartBanner">
    <img th:src="@{/image/cart.png}" alt="장바구니">
</div>

<table class="table">
    <thead>
    <tr>
        <th>Product</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Shipping</th>
        <th>SubTotal</th>
        <th></th>
    </tr>
    </thead>

    <tbody th:if="${session.cartItems != null}">
    <tr th:each="cartItem : ${session.cartItems}">
        <td th:each="product : ${cartItem.products}" th:text="${product.proName}"></td>
        <td th:each="product : ${cartItem.products}" th:text="${product.proPrice}"></td>
        <td th:text="${cartItem.cartQuantity}"></td>
        <td th:each="product : ${cartItem.products}" th:text="${product.shipping}"></td>
        <td>
            <!-- 상품가격 + 상품의 배송비 합계 -->
            <span th:each="product : ${cartItem.products}" th:text="${product.proPrice * cartItem.cartQuantity + product.shipping}"></span>
        </td>
        <td>
            <!-- 폼데이터가 전송될 URL userNo에 따라 동적으로 변경 -->
            <!-- 이후에 post방식으로 변경 예정 -->
            <form th:each="product : ${cartItem.products}" th:action="@{/cart/delete}" method="get">
                <input type="hidden" id="userNo" name="userNo" />
                <input type="hidden" id="proNo" name="proNo" />
                <button type="submit" class="btn btn-danger" style="background-color: transparent; border: none; padding: 0;">
                    <img th:src="@{/image/delete.png}" alt="Delete" height="15px" width="15px">
                </button>
            </form>
            <!--
            <form th:each="product : ${cartItem.products}" th:action="@{/cart/delete}" method="post">
                <input type="hidden" name="userNo" th:value="${cartItem.userNo}" />
                <input type="hidden" name="proNo" th:value="${product.proNo}" />
                <button type="submit" class="btn btn-danger" style="background-color: transparent; border: none; padding: 0;">
                    <img th:src="@{/image/delete.png}" alt="Delete" height="15px" width="15px">
                 </button>
            </form>
              -->
        </td>
    </tr>
    </tbody>

</table>

<br><br><br><br>

<!-- 쇼핑 계속하기  -->
<div class="continueShopping">
    <a th:href="@{/}">쇼핑 계속하기</a>
</div>

<!-- 장바구니 총액 -->
<hr>
<table class="table">
    <tbody>
    <tr>
        <td><strong>Total</strong></td>
        <td id="totalAmount"></td>
    </tr>
    </tbody>
</table>
<hr>

<!-- 체크아웃 버튼 -->
<div class="checkoutBtn">
    <a href="#" class="btn btn-primary btn-rounded btn-block btn-lg fw-bold">Check out</a>
</div>

<!-- 푸터 포함 -->
<footer th:replace="~{footer :: footer}"></footer>

<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js"></script>
<script th:inline="javascript">

    document.addEventListener('DOMContentLoaded', function() {
        var deleteButtons = document.querySelectorAll('.btn-danger');
        deleteButtons.forEach(function(button) {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                var form = button.closest('form');

                var userNo = form.querySelector('input[name="userNo"]').value;
                var proNo = form.querySelector('input[name="proNo"]').value;

                console.log("UserNo: " + userNo + ", ProNo: " + proNo);

                // userNo, proNo 유효성 검사
                if (userNo.trim() !== "" && proNo.trim() !== "") {
                    document.getElementById('userNo').value = userNo;
                    document.getElementById('proNo').value = proNo;

                    form.submit();
                } else {
                    console.error("Invalid userNo or proNo");
                }
            });
        });
    });


    document.addEventListener('DOMContentLoaded', function() {
        var totalAmount = 0;
        //세션에서 cartItem 데이터 가져오기
        var cartItems = [[${session.cartItems}]];

        //Total 계산하기
        cartItems.forEach(function(cartItem) {
            cartItem.products.forEach(function(product) {
                var productTotal = product.proPrice * cartItem.cartQuantity + product.shipping;
                totalAmount += productTotal;
            });
        });

        //세자리 단위로 콤마로 포맷 맞추기
        var formattedTotal = totalAmount.toLocaleString('ko-KR');
        document.getElementById('totalAmount').textContent = formattedTotal + ' 원';
    });
</script>

</body>
</html>